<!DOCTYPE html>
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
<link rel="stylesheet" href="style.css" type="text/css">
</head>
<body onload="">
<header>
   <div class="headerinfo">
      <h1>SoundScape</h1>
      <input type="text" placeholder="find your jam..." />
  </div>

  <div class="songinfo">
    <div class="info">
      <h1 id="songTitle">placeholder</h1>
      <h5 id="albumTitle">placeholder</h5>
      <h6 id="artistTitle">placeholder</h5>
    </div>
      <div class="img">
        <img id="albumArt" src="tooreal.jpg"/>

      </div>
  </div>
</header>
<canvas id="canvas"></canvas>

<script type="text/javascript">

const albumArt = document.getElementById('albumArt');
const songTitle = document.getElementById('songTitle');
const albumTitle = document.getElementById('albumTitle');

let bpm = 100;




const highEnergy = "rgba(168, 166, 254, 0.8)";
const midEnergy = "rgba(34, 30, 255, 0.8)";
const lowEnergy = "rgba(6, 4, 119, 0.8)";


setInteval(function getCurrentSong(){
  let currentSong = new Object();
  const url = window.location.href;
  //console.log(url);
  const urlSplit = url.split('token=');
  const token = urlSplit[1].substring(0,urlSplit[1].indexOf('&'));
  //console.log(token);
  fetch("https://api.spotify.com/v1/me/player/currently-playing", {
    headers: {
      Accept: "application/json",
      Authorization: "Bearer " + token,
      "Content-Type": "application/json"
    }
  })
    .then(function(response){
      return response.json();
    })
    .then(function(responseAsJson){
        //console.log(responseAsJson);
        currentSong = responseAsJson;
        if (songTitle.innerHTML == currentSong.item.name){
          console.log("same song");
          return;
        }
        else {
          console.log("test");
          albumArt.src = currentSong.item.album.images[0].url;
          songTitle.innerHTML = currentSong.item.name;
          albumTitle.innerHTML = currentSong.item.album.name;
          artistTitle.innerHTML = currentSong.item.album.artists[0].name;
          getAudioFeatures(currentSong, token);
        }

      });
}, 1000);

// function getAudioAnalysis(currentSong, token){
//   let currentSection = new Object();
//   //track.sections.start
//   fetch("https://api.spotify.com/v1/audio-analysis/" + currentSong.item.id, {
//     headers: {
//       Accept: "application/json",
//       Authorization: "Bearer " + token,
//       "Content-Type": "application/json"
//     }
//   })
//     .then(function(response){
//       return response.json();
//     })
//     .then(function(responseAsJson){
//         //console.log(responseAsJson);
//         audioAnalysis = responseAsJson;
//         return audioAnalysis;
//       })
//       .then(function(audioAnalysis){
//         getAudioFeatures(currentSong, audioAnalysis, token);
//       });
// }

function getAudioFeatures(currentSong, token){
  console.log("audioFeaturesRunning");
  let trackFeatures = new Object();
  //console.log(currentSong.id);
  const audioFeaturesEndpt =  "https://api.spotify.com/v1/audio-features/" + currentSong.item.id;
  fetch(audioFeaturesEndpt, {
    headers: {
      Accept: "application/json",
      Authorization: "Bearer " + token,
      "Content-Type": "application/json"
    }
  })
  .then(function(response){
    return response.json();
  })
  .then(function(responseAsJson){
    trackFeatures = responseAsJson;
    return trackFeatures;
  })
  .then(function(trackFeatures){
    visualizer(trackFeatures, currentSong);

  });
}


function visualizer(trackFeatures, currentSong){
  console.log("visualize running");

  let currentPoint = currentSong.progress_ms;
  console.log(trackFeatures);
   bpm = trackFeatures.tempo;
   return bpm;

}



var canvas = document.getElementById('canvas');
var c = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

var randomColor = "rgba(" + Math.floor(Math.random() * 256)+","+Math.floor(Math.random() * 256)+","+Math.floor(Math.random() * 256)+",0.8)";

var circleArray = [];


for(let i=1; i<1000; i++){
  var x = 500;
  var y = 500;
  var radius = Math.floor(Math.random() * 256);
  (function(i){
    setTimeout(function(){
      console.log(i);
        circleArray.push(new Circle(this.x, this.y, this.radius));
        bpm.addEventListener
        console.log(bpm);
        i++;
    }, 60000/bpm * i);
})(i);
}

var circle = new Circle(x, y, radius, randomColor);

animate();

function Circle(x, y, radius){
  this.x = x;
  this.y = y;
  this.radius = 55;
  this.randomStroke = "rgba(" + Math.floor(Math.random() * 256) + "," + Math.floor(Math.random() * 256) + "," + Math.floor(Math.random() * 256) + ",0.8)";;
  this.randomFill = "rgba(" + Math.floor(Math.random() * 256) + "," + Math.floor(Math.random() * 256) + "," + Math.floor(Math.random() * 256) + ",0.8)";;

  this.draw = function() {
    c.beginPath();
    c.arc(this.x, this.y, this.radius, Math.PI * 2, false);
    c.strokeStyle =  this.randomStroke;
    c.fillStyle = this.randomFill;
    c.lineWidth = 15;
    c.stroke();
    c.fill();
    this.update();
    //console.log(this.x);
    //console.log(this.y);
    //console.log(radius);
  }

  this.update = function(){
    if (this.radius > 1500){
      cancelAnimationFrame(animate);
    }
    this.radius+=10;
  }
}
function animate(){
requestAnimationFrame(animate);
c.clearRect(0, 0, innerWidth, innerHeight);
for (let i=0; i<circleArray.length; i++){
  circleArray[i].draw();
  console.log("drawn");


}

}





</script>
</body>
</html>
