<!DOCTYPE html>
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
<link rel="stylesheet" href="style.css" type="text/css">
</head>
<body onload="">
<header>
   <div class="headerinfo">
      <h1>SoundScape</h1>
  </div>

  <div class="songinfo">
    <div class="info">
      <h1 id="songTitle">placeholder</h1>
      <h5 id="albumTitle">placeholder</h5>
      <h6 id="artistTitle">placeholder</h5>
    </div>
      <div class="img">
        <img id="albumArt" src="tooreal.jpg"/>

      </div>
  </div>
</header>
<canvas id="canvas"></canvas>

<script type="text/javascript">

const albumArt = document.getElementById('albumArt');
const songTitle = document.getElementById('songTitle');
const albumTitle = document.getElementById('albumTitle');

let bpm = 100;




const highEnergy = "rgba(168, 166, 254, 0.8)";
const midEnergy = "rgba(34, 30, 255, 0.8)";
const lowEnergy = "rgba(6, 4, 119, 0.8)";

var circleArray = [];


setInterval(function getCurrentSong(){
  let currentSong = new Object();
  const url = window.location.href;
  //console.log(url);
  const urlSplit = url.split('token=');
  const token = urlSplit[1].substring(0,urlSplit[1].indexOf('&'));
  //console.log(token);
  fetch("https://api.spotify.com/v1/me/player/currently-playing", {
    headers: {
      Accept: "application/json",
      Authorization: "Bearer " + token,
      "Content-Type": "application/json"
    }
  })
    .then(function(response){
      return response.json();
    })
    .then(function(responseAsJson){
        //console.log(responseAsJson);
        currentSong = responseAsJson;
        if (songTitle.innerHTML == currentSong.item.name){
          // console.log("same song");
          return;
        }
        else {
          // console.log("test");

          albumArt.src = currentSong.item.album.images[0].url;
          songTitle.innerHTML = currentSong.item.name;
          albumTitle.innerHTML = currentSong.item.album.name;
          artistTitle.innerHTML = currentSong.item.album.artists[0].name;
          getAudioFeatures(currentSong, token);
        }

      });
}, 1000);

function getAudioAnalysis(trackFeatures, token, currentSong){
  let currentSection = new Object();
  //track.sections.start
  fetch("https://api.spotify.com/v1/audio-analysis/" + currentSong.item.id, {
    headers: {
      Accept: "application/json",
      Authorization: "Bearer " + token,
      "Content-Type": "application/json"
    }
  })
    .then(function(response){
      return response.json();
    })
    .then(function(responseAsJson){
        //console.log(responseAsJson);
        audioAnalysis = responseAsJson;
        return audioAnalysis;
      })
      .then(function(audioAnalysis){
        // getAudioFeatures(currentSong, audioAnalysis, token);
        console.log('viz');
        visualizer(trackFeatures, currentSong, audioAnalysis);
      });
}

function getAudioFeatures(currentSong, token){
  console.log("audioFeaturesRunning");
  let trackFeatures = new Object();
  //console.log(currentSong.id);
  const audioFeaturesEndpt =  "https://api.spotify.com/v1/audio-features/" + currentSong.item.id;
  fetch(audioFeaturesEndpt, {
    headers: {
      Accept: "application/json",
      Authorization: "Bearer " + token,
      "Content-Type": "application/json"
    }
  })
  .then(function(response){
    return response.json();
  })
  .then(function(responseAsJson){
    trackFeatures = responseAsJson;
    return trackFeatures;
  })
  .then(function(trackFeatures){
    //visualizer(trackFeatures, currentSong);
    getAudioAnalysis(trackFeatures,token, currentSong);

  });
}
var t;


function visualizer(trackFeatures, currentSong, audioAnalysis){
  console.log("visualize running");

  let currentPoint = currentSong.progress_ms;
  console.log(trackFeatures);
   bpm = trackFeatures.tempo;
   console.log(bpm);
   createCircs(bpm);

}


var canvas = document.getElementById('canvas');
var c = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

var randomColor = "rgba(" + Math.floor(Math.random() * 256)+","+Math.floor(Math.random() * 256)+","+Math.floor(Math.random() * 256)+",0.8)";

function createCircs(bpm){
  clearTimeout(t);

  i = 1;
  circleArray.length = 0;
  cancelAnimationFrame(animate);
  //c.clearRect(0, 0, window.width, window.height);
  circleArray = [];
  var x = 500;
  var y = 500;
  var radius = Math.floor(Math.random() * 256);
for(let i=1; i<2; i++){
  (function(i){
    console.log(bpm);
    console.log(window.bpm);
    t = setInterval(function(i){
        circleArray.push(new Circle(this.x, this.y, this.radius, bpm));

    }, 60000/bpm * i);
    if (this.bpm != window.bpm){
      return;
    }
})(i);

}


}
animate();

var animateCounter = 0;

function Circle(x, y, radius, bpm){
  console.log(bpm);
  this.x = 760;
  this.y = 800;
  this.radius = 55;
  this.randomStroke = "rgba(" + Math.floor(Math.random() * 256) + "," + Math.floor(Math.random() * 256) + "," + Math.floor(Math.random() * 256) + ",0.8)";
  this.randomFill = "rgba(" + Math.floor(Math.random() * 256) + "," + Math.floor(Math.random() * 256) + "," + Math.floor(Math.random() * 256) + ",0.8)";
  this.draw = function() {
    c.beginPath();
    c.arc(this.x, this.y, this.radius, Math.PI * 2, false);

    // c.strokeStyle =  this.randomStroke;
    c.fillStyle = this.randomFill;
    // c.lineWidth = 5;
    // c.stroke();
    c.fill();
    this.update(bpm);
    //console.log(this.x);
    //console.log(this.y);
    //console.log(radius);
  }
  this.update = function(bpm){
    animateCounter++;
    console.log(animateCounter);
    console.log(bpm);
    console.log(Math.round(60000/bpm));
    if (animateCounter == Math.round(60000/bpm)){
      console.log(animateCounter);

      animateCounter = 0;
      c.beginPath();
      c.fillStyle = "rgba(" + Math.floor(Math.random() * 256) + "," + Math.floor(Math.random() * 256) + "," + Math.floor(Math.random() * 256) + ",0.8)";
      c.fill();

    }
    if (this.radius > 1200){
      this.radius = 55;
    }

    this.radius+=5;
  }
}
function animate(){
requestAnimationFrame(animate);
c.clearRect(0, 0, innerWidth, innerHeight);
for (let i=0; i<circleArray.length; i++){
  circleArray[i].draw();


}

}






</script>
</body>
</html>
